name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install --legacy-peer-deps

    - name: Refresh content and check for updates
      run: |
        echo "ğŸ”„ Refreshing content..."
        # Check for any content updates or regenerate dynamic content
        npm run refresh-content || echo "âš ï¸ Content refresh script not found, skipping..."
        echo "âœ… Content refresh completed"

    - name: Generate SEO files
      run: |
        npm run generate-index
        npm run generate-sitemap
        npm run generate-robots
        echo "âœ… SEO files generated successfully"

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Post-deployment SEO verification
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸ“ Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ—ºï¸ Sitemap: ${{ steps.deployment.outputs.page_url }}sitemap.xml"
        echo "ğŸ¤– Robots.txt: ${{ steps.deployment.outputs.page_url }}robots.txt"
        echo ""
        echo "ğŸ“‹ Next steps for SEO:"
        echo "1. Submit sitemap to Google Search Console"
        echo "2. Submit sitemap to Bing Webmaster Tools" 
        echo "3. Test with Google Rich Results Test"
        echo "4. Verify OpenGraph tags with Facebook Debugger" 